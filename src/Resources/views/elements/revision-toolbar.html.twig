{% trans_default_domain 'emsco-twigs' -%}
<div class="btn-group{% if vertical is defined and vertical %}-vertical{% endif %}">
	{% if withView is not defined or withView %}
        {% include '@EMSCore/elements/get-button.html.twig' with {
				'url': path('data.revisions', {
					'type': instance.contentType.name,
					'ouuid': instance.ouuid,
					'revisionId': revisionId,
					'btnType': 'primary',
				}),
				'label': 'views.elements.revision-toolbar-html.view-label'|trans,
				'icon': 'eye' }%}
	{% endif %}
	{% if draft %} 	
		{% if is_granted(instance.contentType.editRole) %}
			{% if not  instance.contentType.circlesField or attribute(instance.rawData, instance.contentType.circlesField) is not defined or attribute(instance.rawData, instance.contentType.circlesField)|in_my_circles %}
    {% include '@EMSCore/elements/get-button.html.twig' with {
					'url': path('revision.edit', {'revisionId': revisionId}),
					'label': 'views.elements.revision-toolbar-html.edit-draft-label'|trans,
					'btnType': 'primary',
					'icon': 'pencil' }%}
				{% if autoSave  %}
                    {% include '@EMSCore/elements/post-button.html.twig' with {
						'url': path('revision.cancel', {'revision': revisionId}),
						'message': 'views.elements.revision-toolbar-html.cancel-message'|trans,
						'label': 'views.elements.revision-toolbar-html.cancel-label'|trans,
						'btnType': 'default',
						'icon': 'remove'
					}%}
				{% endif %}
				</div>
				<div class="btn-group">
                    {% if not autoSave  %}
						{% include '@EMSCore/elements/post-button.html.twig' with {
							'url': path('revision.finalize', {'revision': revisionId}),
							'message': 'views.elements.revision-toolbar-html.finalize-draft-message'|trans,
							'label': 'views.elements.revision-toolbar-html.finalize-draft-label'|trans({'%environment%': instance.contentType.environment.label|default('')}),
							'btnType': 'default',
							'icon': 'check'
						}%}
                    {% endif %}
                    {% include '@EMSCore/elements/post-button.html.twig' with {
					'url': path('revision.discard', {'revisionId': revisionId}),
					'label': 'views.elements.revision-toolbar-html.discard-draft-label'|trans,
					'message': 'views.elements.revision-toolbar-html.discard-draft-message'|trans,
					'btnType': 'danger',
					'icon': 'trash'
				}%}
			{% endif %}
		{% endif %}
	{% else %}
		{# TODO: better way to determine if there is a environement to publish this revision in ? #}
		{# twig function ?#}
		{% set hasEnv = false %}
		{% for env in availableEnv %}
			{% if env not in environments %}
	   			{% set hasEnv = true %}
		   	{% endif %}
	   	{% endfor %}
	   	
		
		{% for env in environments %}
            {% include '@EMSCore/elements/object-views-button.html.twig' with {
				'object':  object,
				'contentType': instance.contentType,
				'environment': env,
				'ouuid': revision.ouuid
			}%}
   		{% endfor %}


	   	{% if is_granted(instance.contentType.editRole) %}
	   		{% if not  instance.contentType.circlesField or attribute(object._source,instance.contentType.circlesField) is not defined or attribute(object._source,instance.contentType.circlesField)|in_my_circles %}
                {% if draft %}
                    {% include '@EMSCore/elements/get-button.html.twig' with {
						'url': path('revision.edit', {'revisionId': revisionId}),
						'btnType': 'primary',
						'label': 'views.elements.revision-toolbar-html.edit-draft-label'|trans,
						'icon': 'pencil' }%}
					{% if autoSave  %}
                        {% include '@EMSCore/elements/post-button.html.twig' with {
							'url': path('revision.cancel', {'revision': revisionId}),
							'btnType': 'default',
							'label': 'views.elements.revision-toolbar-html.cancel-last-updates-label'|trans,
							'message': 'views.elements.revision-toolbar-html.cancel-last-updates-message'|trans,
							'icon': 'remove'
						}%}
					{% endif %}
                {% elseif current %}
                    {% include '@EMSCore/elements/post-button.html.twig' with {
						'url': path('revision.new-draft', {'ouuid': revision.ouuid, 'type':revision.contentType.name }),
						'label': 'views.elements.revision-toolbar-html.new-draft-label'|trans,
						'icon': 'pencil' }%}
				{% else %}
					{% if instance.contentType.fieldType.fieldsRoles|one_granted(true) %}
                        {% include '@EMSCore/elements/get-button.html.twig' with {
							'url': path('revision.edit', {'revisionId': revisionId}),
							'btnType': 'default',
							'label': 'views.elements.revision-toolbar-html.edit-revision-label'|trans,
							'icon': 'pencil' }%}
					{% endif %}
					{% if autoSave  %}
                        {% include '@EMSCore/elements/post-button.html.twig' with {
							'url': path('revision.cancel', {'revision': revisionId}),
							'btnType': 'default',
							'message': 'views.elements.revision-toolbar-html.cancel-last-updates-message'|trans,
							'label': 'views.elements.revision-toolbar-html.cancel-last-updates-label'|trans,
							'icon': 'remove'
						}%}
					{% endif %}
                    {% include '@EMSCore/elements/post-button.html.twig' with {
						'url': path('revision.revert', {'id': revisionId}),
						'btnType': 'default',
						'label': 'views.elements.revision-toolbar-html.revert-revision-label'|trans,
						'icon': 'undo' }%}
				{% endif %}
			{% endif %}
		{% endif %}
			
			</div>
			<div class="btn-group{% if vertical is defined and vertical %}-vertical{% endif %}">
                {% if is_super() %}
                    {% include '@EMSCore/elements/post-button.html.twig' with {
                        'url': path('revision.reindex', {'revisionId': revisionId}),
						'btnType': 'default',
						'label': 'views.elements.revision-toolbar-html.re-index-label'|trans,
                        'icon': 'recycle'}%}
                {% endif %}
		  {% if instance.contentType.publishRole and is_granted(instance.contentType.publishRole) and hasEnv  %}
				<div class="btn-group">
				  <button type="button" class="btn btn-sm btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				    	<span class="fa fa-toggle-on"></span>&nbsp;
						{{ 'views.elements.revision-toolbar-html.publish-to-label'|trans }}
						<span class="caret"></span>
				  </button>
				   <ul class="dropdown-menu">
				   		{% for env in availableEnv %}
				   			<li>
							{% if env not in environments and env.circles|in_my_circles %}
					   				<a href="{{ path('revision.publish_to', {'revisionId': revisionId, 'envId': env.id}) }}">{{ env.label }}</a>
					   		{% endif %}
					   		</li>
				   		{% endfor %}
				   </ul>
				  </div>
		  {% endif %}
		
		  {% if instance.contentType.publishRole and is_granted(instance.contentType.publishRole) and ((environments|length > 0 and not current) or (environments|length > 1 and current)) %}
		  	<div class="btn-group">
				  <button type="button" class="btn btn-sm btn-danger dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				    	<span class="fa fa-toggle-off"></span>&nbsp;
					  	{{ 'views.elements.revision-toolbar-html.unpublish-from-label'|trans }}
						<span class="caret"></span>
				  </button>
				   <ul class="dropdown-menu">
				   		{% for env in availableEnv if env in environments and env.circles|in_my_circles %}
				   			<li>
				   				<a href="{{ path('revision.unpublish', {'revisionId': revisionId, 'envId': env.id}) }}">{{ env.label }}</a>
				   			</li>
				   		{% endfor %}
				   </ul>
			</div>
		  {% endif %}
	{% endif %}
</div>