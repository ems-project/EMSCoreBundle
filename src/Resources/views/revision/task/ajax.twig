{% trans_default_domain 'EMSCoreBundle' %}

{% block currentTask %}
    {%- if task == null -%}
        <div>No task found!</div>
    {%- else -%}
        <div id="task-title">{{ task.title }}</div>
        <div id="task-info">
            <span id="task-deadline {{ task.deadline.timestamp < 'now'|date('U') ? 'task-deadline-red' }}">
                <i class="fa fa-clock-o" aria-hidden="true"></i>&nbsp;{{ task.deadline.format('d/m/Y') }}
            </span>
            <span>{{ 'task.for'|trans }}&nbsp;{{ task.assignee|displayname }}</span>
        </div>
        <span class="label label-{{ task.statusLabel }}">{{ "task.status.#{task.status}"|trans }}</span>
        <p id="task-description">{{ task.description }}</p>
        {% if formRequestValidation is defined and formRequestValidation != null %}
            {% set logRejection = task.getLatestRejection %}
            <div id="task-send-validation">
                <hr />
                {%- if null != logRejection -%}<p class="task-comment bg-danger">{{ logRejection.comment }}</p>{%- endif -%}
                {{ form(formRequestValidation) }}
                <button id="btn-validation-request" class="btn btn-sm btn-primary">{{ 'task.validation.request'|trans  }}</button>
            </div>
        {% endif %}
        <div class="clearfix">
            <button class="btn-modal-history-task btn btn-sm btn-default pull-right"
                    data-url="{{ path('ems_core_task_ajax_history_modal', {'revisionId': revisionId, 'taskId': task.id }) }}"
                    data-title="{{ 'task.history'|trans }} : {{ task.title }}">
                    <i class="fa fa-comments" aria-hidden="true"></i>
            </button>
        </div>
    {%- endif -%}
{% endblock %}

{% block taskItem %}
    <li class="list-group-item tasks-item {{ isCurrent|default(false) ? 'tasks-item-current' }}">
        <div class="tasks-item-block">
            <div class="tasks-item-info">
                <i class="{{ task.statusIcon }}"></i>
                <div>
                    <div class="tasks-item-title">{{ task.title }}</div>
                    <div>{{ 'task.assigned_to'|trans }}<strong>{{ task.assignee|displayname }}</strong></div>
                    {% if isCurrent|default(false) %}
                        <div><span class="label label-{{ task.statusLabel }}">{{ "task.status.#{task.status}"|trans }}</span></div>
                    {% endif %}
                </div>
            </div>
            <button class="btn-task-update-modal btn btn-sm pull-right"
                    data-title="{{ 'task.update.title'|trans({ '%title%': task.title }) }}"
                    data-url="{{ path('ems_core_task_ajax_update_modal', { revisionId: revision.id, taskId: task.id }) }}">
                <i class="fa fa-pencil-square-o"></i>
            </button>
        </div>
        {% if formValidation is defined %}
            <div class="tasks-item-validation">
                {% set logCompleted = task.getLatestCompleted %}
                {% if task.assignee != app.user.username and logCompleted != null %}
                    <p class="task-comment bg-gray-light">{{ logCompleted.comment }}</p>
                {% endif %}
                {{ form(formValidation) }}
                {% if task.assignee == app.user.username %}
                    <button id="btn-task-validation-approve" class="btn btn-sm btn-primary">{{ 'task.validation.done'|trans  }}</button>
                {% else %}
                    <button id="btn-task-validation-approve" class="btn btn-sm btn-primary">{{ 'task.validation.approve'|trans  }}</button>
                    <button id="btn-task-validation-reject" class="btn btn-sm btn-default pull-right">{{ 'task.validation.reject'|trans  }}</button>
                {% endif %}
            </div>
        {% endif %}
    </li>
{% endblock %}

{% block taskItemApproved %}
    <li class="list-group-item tasks-item"
        data-url="{{ path('ems_core_task_ajax_task_modal', {'revisionId': revision.id, 'taskId': task.id }) }}"
        data-title="Task: {{ task.title }}">
        <div class="tasks-item-block">
            <div class="tasks-item-info">
                <i class="{{ task.statusIcon }}"></i>
                <div>
                    <div class="tasks-item-title">{{ task.title }}</div>
                    <div>{{ 'task.assigned_to'|trans }} <strong>{{ task.assignee|displayname }}</strong></div>
                </div>
            </div>
        </div>
    </li>
{% endblock %}

{% block tasksApprovedLink %}
    {%- if count > 0 -%}
        <a href="#" id="btn-tasks-approved"
           data-toggle="false"
           data-toggle-text="{{ 'task.finished.hide'|trans({ '%number%': count }) }}">
            {{- 'task.finished.show'|trans({ '%number%': count }) -}}
        </a>
    {%- endif -%}
{% endblock %}

{% block modalFooterClose %}
    <div class="pull-left">
        <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">Close</button>
    </div>
{% endblock %}

{% block modalCreateBody %}
    {{ block('taskForm') }}
{% endblock %}

{% block modalCreateFooter %}
    <div class="pull-left">
        <button id="ajax-modal-submit" class="btn btn-sm btn-primary">{{ 'task.create.submit'|trans }}</button>
        <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">Cancel</button>
    </div>
{% endblock %}

{% block modalTaskBody %}
    <div class="nav-tabs-custom">
        <ul class="nav nav-tabs">
            <li class="active">
                <a href="#tab_task_info" data-toggle="tab" aria-expanded="true">
                    <i class="fa fa-info-circle" aria-hidden="true"></i>&nbsp;{{ 'task.update.tab.info'|trans }}
                </a>
            </li>
            <li>
                <a href="#tab_task_history" data-toggle="tab" aria-expanded="false">
                    <i class="fa fa-comments" aria-hidden="true"></i>&nbsp;{{ 'task.update.tab.history'|trans }}
                </a>
            </li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane active" id="tab_task_info">
                {% if form is defined %}
                    {{ block('taskForm') }}
                {% else %}
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <div class="mb-1"><strong>{{ 'task.field.title'|trans }}</strong></div>
                            <div>{{ task.title }}</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="mb-1"><strong>{{ 'task.field.deadline'|trans }}</strong></div>
                            <div>{{ task.deadline.format('d/m/y') }}</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="mb-1"><strong>{{ 'task.field.assignee'|trans }}</strong></div>
                            <div>{{ task.assignee|displayname }}</div>
                        </div>
                        <div class="col-md-12 mb-3">
                            <div class="mb-1"><strong>{{ 'task.field.description'|trans }}</strong></div>
                            <div>{{ task.description|displayname }}</div>
                        </div>
                    </div>
                {% endif %}
            </div>
            <div class="tab-pane" id="tab_task_history">{{ block('renderHistoryTimeline') }}</div>
        </div>
    </div>
{% endblock %}

{% block modalUpdateFooter %}
    <div class="pull-left">
        <button id="ajax-modal-submit" class="btn btn-sm btn-primary">{{ 'task.update.submit'|trans }}</button>
        <button type="button" class="btn btn-sm btn-default" data-dismiss="modal">Close</button>
    </div>
    <div class="pull-right">
        <button type="button" id="btn-task-delete"
                data-url="{{ path('ems_core_task_ajax_delete', {'revisionId': revisionId, 'taskId': task.id}) }}"
                class="btn btn-sm btn-danger"><i class="fa fa-trash"></i> {{ 'task.delete.submit'|trans }}</button>
    </div>
{% endblock %}

{% block modalHistoryBody %}{{ block('renderHistoryTimeline') }}{% endblock %}

{% block taskForm %}
    {{ form_start(form) }}
    <div class="row">
        <div class="col-md-12">{{ form_row(form.title) }}</div>
        <div class="col-md-6">{{ form_row(form.deadline) }}</div>
        <div class="col-md-6">{{ form_row(form.assignee) }}</div>
        <div class="col-md-12">{{ form_row(form.description) }}</div>
    </div>
    {{ form_end(form) }}
{% endblock %}

{% block renderHistoryTimeline %}
    <ul class="timeline">
        {% for log in task.logs|reverse %}
            <li>
                <i class="{{ log.icon }}"></i>
                <div class="timeline-item">
                    <span class="time"><i class="fa fa-clock-o"></i> {{ log.date.format('d/m/Y H:i') }}</span>
                    <h3 class="timeline-header bg-info">
                        <strong>{{ log.username == app.user.username ? 'You' : log.username|displayname }}</strong>
                        {{ "task.status.#{log.status}"|trans|lower }}
                    </h3>
                    {% if log.comment %}<div class="timeline-body bg-gray-light">{{ log.comment }}</div>{% endif %}
                </div>
            </li>
        {% endfor %}
    </ul>
{% endblock %}